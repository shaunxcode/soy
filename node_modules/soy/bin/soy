#!/usr/bin/env node
(function() {
  var argv, desugared, expanded, fs, m, out, parsed, result, soy,
    __slice = Array.prototype.slice;

  argv = require("optimist").usage('work with soy files.\nUsage: $0').demand('f').alias('f', 'file').describe('f', 'load a file').alias('v', 'verbose').describe('v', 'verbose info').alias('m', 'mode').describe('m', 'set mode (r: read, rd: read desugar, rde: read desugar expand, e: eval)')["default"]('m', 'e').argv;

  soy = require('../soy');

  fs = require("fs");

  m = argv.m;

  out = function() {
    var msg;
    msg = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    msg.push("\n");
    if (argv.v) console.log.apply(this, msg);
    return msg;
  };

  soy.setCurrentDir(argv.f.split('/').slice(0, -1).join('/') + '/');

  parsed = soy.load(argv.f);

  out("Parsed", soy.to_string(parsed));

  if (m === 'rd' || m === 'rde' || m === 'e') {
    desugared = soy.desugar(parsed);
    out("Desugared", soy.to_string(desugared));
  }

  if (m === 'rde' || m === 'e') {
    expanded = soy.expand(desugared, true);
    out("Expanded", soy.to_string(expanded));
  }

  if (m === 'e') result = soy.eval(expanded);

}).call(this);
