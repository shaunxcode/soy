#!/usr/bin/env node
(function() {
  var cli, quit, readOnly, rl, soy;

  rl = require('readline');

  cli = rl.createInterface(process.stdin, process.stdout, null);

  cli.setPrompt("soy repl> ");

  quit = function() {
    return process.exit();
  };

  cli.input.on('keypress', function(chunk, key) {
    if (key && key.ctrl && key.name === 'c') {
      console.log("\n");
      return quit();
    }
  });

  soy = require('../soy');

  readOnly = false;

  cli.on('line', function(line) {
    var _ref;
    if (line === 'quit') quit();
    if (line === 'env') console.log(soy.topLevel);
    if (line === 'rp') {
      readOnly = true;
      console.log("Entering read, print loop");
      cli.setPrompt("soy rpl> ");
    } else if (line === 'rep') {
      readOnly = false;
      console.log("Entering read, eval, print loop");
      cli.setPrompt("soy repl> ");
    } else {
      try {
        if (!((_ref = line.trim()[0]) === "(" || _ref === "{" || _ref === "[")) {
          line = "(value (" + line + "))";
        }
        console.log(soy.to_string(readOnly ? soy.expand(soy.desugar(soy.parse(line))) : soy.eval(soy.expand(soy.desugar(soy.parse(line)), true))));
      } catch (e) {
        console.log(e);
      }
    }
    return cli.prompt();
  });

  cli.prompt();

}).call(this);
